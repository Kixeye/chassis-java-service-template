if(!window.TRIALPAY){window.TRIALPAY={fb:{show_overlay:function(fb_app_id,mode,params){var clientInstance=TRIALPAY._dev.getLastClientInstance();if(!clientInstance){clientInstance=TRIALPAY._dev.createClientInstance('offer_wall','tp_auto_id_'+(new Date()).getTime(),params);clientInstance._params.app_id=fb_app_id};params=params||{};this._params=params;switch(mode){case"tpdirect":params.fb_app_id=fb_app_id;params.context=1001;params.use_post=true;if(params.dealspot){params.context=1002;params.hide_close_x=true;if(params.tp_item_name||params.tp_item_map)params.context=1100};var host=false,url="/fbdispatch/";TRIALPAY.social._show_overlay(url,params,host);break;case"fbdirect":if(!params.sid){window.console&&console.error&&console.error("TrialPay: the 'sid' parameter is required.");return};if(!params.tp_vendor_id){window.console&&console.error&&console.error("TrialPay: the 'tp_vendor_id' parameter is required.");return};if(!params.fb_tpi){var callback=function(fb_tpi){params.fb_tpi=fb_tpi;TRIALPAY.fb.show_overlay(fb_app_id,mode,params)};this.get_fb_tpi(callback);return}else if(params.fb_tpi=='unavailable')delete params.fb_tpi;params.fb_app_id=fb_app_id;if(params.context==1005){params.dealspot=false}else params.context=1003;params.use_post=true;params.hide_close_x=true;params.width=640;if(params.height){params.override_height=params.height<300?125:params.height-175}else params.height=625;var url="/fbdispatch/";if(params.dealspot){params.context=1004;if(params.tp_item_name||params.tp_item_map)params.context=1100;TRIALPAY.social._show_overlay(url,params,false)}else this._show_offer_wall(fb_app_id,url,params,clientInstance);break;case"fbpayments":if(params.onTransact){TRIALPAY.social._on_transact=params.onTransact;delete params.onTransact};if(params.onClose){TRIALPAY.social._on_close=params.onClose;delete params.onClose};if(params.onOpen){TRIALPAY.social._on_open=params.onOpen;delete params.onOpen};delete params.onSoldout;delete params.onResizeOverlay;params.zIndex=9999;params.fb_app_id=fb_app_id;params.context=3;if(params.dealspot)params.context=4;var url="/fbdispatch/";TRIALPAY.social._show_overlay(url,params,false);break;case"split":this.show_overlay(fb_app_id,(Math.random()>0.5?"tpdirect":"fbpayments"),params);break;default:throw "unknown mode:"+mode}},_show_offer_wall:function(fb_app_id,url,params,clientInstance){var store=false,now=(new Date()).getTime();if(window.sessionStorage){store=sessionStorage.TRIALPAY||"{}";store=JSON.parse(store);if(!store.users)store.users={};if(!store.users[fb_app_id])store.users[fb_app_id]={};if(!store.users[fb_app_id][params.sid])store.users[fb_app_id][params.sid]={};if(store.users[fb_app_id][params.sid].date_updated){params.tp_user_payload=store.users[fb_app_id][params.sid].tp_user_payload;params.tp_user_aes_iv=store.users[fb_app_id][params.sid].tp_user_aes_iv;TRIALPAY.social._show_overlay(url,params,false);return}};var fetch_offers_params={};fetch_offers_params.fb_app_id=(1003==params.context||1005==params.context)?'194802560558518':params.fb_app_id;fetch_offers_params.context=(1005==params.context)?1003:params.context;fetch_offers_params.tp_vendor_id=params.tp_vendor_id;var error_callback=function(event){var err_msg=(event&&event.message)?' Error message: '+event.message:'';window.console&&console.error&&console.error("TrialPay: Unable to retrieve demo data. User might not be logged into Facebook."+err_msg);TRIALPAY.social._show_overlay(url,params,false)},success_callback=function(obj){if(obj.tp_user_payload){store.users[fb_app_id][params.sid].tp_user_payload=params.tp_user_payload=obj.tp_user_payload;store.users[fb_app_id][params.sid].tp_user_aes_iv=params.tp_user_aes_iv=obj.tp_user_aes_iv;store.users[fb_app_id][params.sid].date_updated=now;sessionStorage.TRIALPAY=JSON.stringify(store);TRIALPAY.social._show_overlay(url,params,false)}else error_callback()};TRIALPAY.fb.fetch_offers(TRIALPAY.io.http_build_query('?',fetch_offers_params).substr(1),clientInstance._id,success_callback,error_callback)},_offer_data:{},fetch_offers:function(params,client_id,callback,error_callback){var clientInstance=false;if(client_id){clientInstance=TRIALPAY._dev.getClientInstance(client_id)}else clientInstance=TRIALPAY._dev.getLastClientInstance();if(!clientInstance)return;var key='',options=TRIALPAY.io.parse_str(params);if(options.context)key=options.context;TRIALPAY.fb["set_offers"+key]=function(obj){this._offer_data[key]=obj;if(callback)callback.call(window,obj)};delete this._offer_data[key];if(false&&options.iso2){var cdn="subdomain=geocf"}else var cdn="subdomain=geo";if(/^https?:\/\/geodev2\.tp-cdn\.com/.test(clientInstance._config.GEO_HOST)){cdn="subdomain=geodev2"}else if(!/^https?:\/\/geo\.tp-cdn\.com/.test(clientInstance._config.GEO_HOST))cdn="subdomain=geodev";var url="https://www.facebook.com/payments/provider_redirect.php?is_cdn=true&"+cdn+"&jsonp=TRIALPAY.fb.set_offers"+key+"&"+params;if(options.tp_vendor_id!="MPOK33BO")url+="&pe=1";TRIALPAY.io.inject_script(url,false,error_callback)},get_offers:function(params){var key='';if(params){var options=TRIALPAY.io.parse_str(params);if(options.context)key=options.context};return this._offer_data[key]},_get_canvas_iframe:function(check_frame_access){var frame=window;while(frame.parent!=window.top)frame=frame.parent;if(check_frame_access)try{var tmp=frame.location.href}catch(e){if(window.console&&console.error){console.error("TRIALPAY: unable to access top-level canvas iframe because of cross-domain security issue.");console.error("TRIALPAY: iframe url: "+window.location.href);console.error("TRIALPAY: iframe document.domain: "+document.domain)}};return frame},get_fb_tpi:function(callback){var frame=this._get_canvas_iframe();try{frame.FB.api('/me',{fields:'third_party_id'},function(response){if(!response||response.error||!response.third_party_id){callback('unavailable')}else callback(response.third_party_id)})}catch(e){window.setTimeout(function(){callback('unavailable')},1)}}},social:{render_dealspot_swf:function(options,swf_params){var use_banner=true;if((1==options.height)||(1==options.width))use_banner=false;if(use_banner){if(!options.id){if(window.console&&console.error)console.error('TrialPay: render_dealspot_swf: "id" is required');return};if(!options.width)options.width=100;if(!options.height)options.height=100;TRIALPAY.dealspot.display(options.id,options);return};this._render_dealspot_swf(options,swf_params)},_render_dealspot_swf:function(options,swf_params){var options2={src:('https:'==window.location.protocol?'https://s-assets':'http://assets')+".tp-cdn.com/static3/swf/dealspot/dealspot_sa.swf",width:100,height:100,id:"trialpay_dealspot_swf_"+Math.round(Math.random()*1000000)},url_params={};if(options){for(var i in options){if(!options2[i])url_params[i]=options[i];options2[i]=options[i]};delete options};url_params.swf_instance_id=options2.id;var flashvars='';for(var i in url_params)flashvars+="&"+this._encodeURIComponent(i)+"="+this._encodeURIComponent(url_params[i]);var swf_params2={movie:options2.src,flashvars:flashvars,wmode:"transparent",menu:"false",quality:"high",allowScriptAccess:"always",scale:"noscale",bgcolor:"#ffffff"};if(swf_params){for(var i in swf_params)swf_params2[i]=swf_params[i];delete swf_params};var obj_attrs={name:options2.id,id:options2.id,data:options2.src,width:options2.width,height:options2.height,type:"application/x-shockwave-flash"};if(/\WMSIE \d/.test(navigator.userAgent))delete obj_attrs.data;var obj='<object';for(var i in obj_attrs)obj+=' '+i+'="'+this._esc(obj_attrs[i])+'"';obj+='>';for(var i in swf_params2)obj+='<param name="'+this._esc(i)+'" value="'+this._esc(swf_params2[i])+'"/>';obj+='</object>';if("|291549705119|342684208824|130409810307796|144959615576466|".indexOf("|"+options2.app_id+"|")>=0){var timestamp=(new Date()).getTime(),img=new Image();img.src="//www.trialpay.com/mz/?app_id="+options2.app_id+"&ev=swf_render&rand="+timestamp;obj+='<iframe style="width: 1px; height: 1px; border: 0px none white; overflow: hidden;" frameborder="0" scrolling="no" src="//www.trialpay.com/mz/?app_id='+options2.app_id+'&ev=swf_render_iframe&rand='+timestamp+'"></iframe>'};this.render_dealspot_swf._swf_id=options2.id;var node=document.getElementById(options2.id);if(!node){if(window.console&&window.console.log)console.log("TrialPay: could not find id: "+options2.id);document.write(obj)}else{var span=document.createElement('span');span.innerHTML=obj;span=span.firstChild;if(obj_attrs.width<=2)span.style.position="absolute";node.parentNode.replaceChild(span,node)}},delete_dealspot_swf:function(id){if(id&&typeof (id)!="string")id=false;if(!id)id=TRIALPAY.social.render_dealspot_swf._swf_id;if(id){var node=document.getElementById(id);if(node){node.parentNode.removeChild(node)}else if(window.console&&console.error)console.error("TrialPay: Could not find element with ID:"+id);if(id==TRIALPAY.social.render_dealspot_swf._swf_id)delete TRIALPAY.social.render_dealspot_swf._swf_id}},_esc:function(str){str=""+str;str=str.replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/"/g,"&quot;").replace(/'/g,"&#039;");return str},_encodeURIComponent:function(str){str=window.encodeURIComponent(str);return str.replace(/'/g,'%27')},_set_flash_visibility:function(hide,frameDoc){var swfs=frameDoc.getElementsByTagName('object');for(var i=0;i<swfs.length;i++){var swf=swfs[i];swf.style.visibility=(hide?'hidden':'visible')}},show_overlay:function(vic,sid,params){if(!vic)vic=this._default_vic;if(!sid)sid=(this._default_sid?this._default_sid:'');var overlay_type='offerwall';if(params&&params.overlay_type)overlay_type=params.overlay_type;var url=(('dotd'==overlay_type)?"/custom/dotd/":"/dispatch/"+vic);url+='?sid='+encodeURIComponent(sid);var clientInstance=TRIALPAY._dev.getLastClientInstance();if(!clientInstance){clientInstance=TRIALPAY._dev.createClientInstance('offer_wall','tp_auto_id_'+(new Date()).getTime());clientInstance._params.vic=vic};this._show_overlay(url,params)},_show_overlay:function(url,params,host){this.close_overlay(true);this._positionTop=false;this._positionLeft=false;this._auto_hide_flash=false;var win_width=585,win_height=575,zIndex=false,scrolling='no',overlay_type='offerwall',use_post=false,show_close_x=true,tp_hide_chrome=false;if(params||this._default_params){var copy={};if(this._default_params)for(var key in this._default_params)copy[key]=this._default_params[key];if(params)for(var key in params)copy[key]=params[key];params=copy;if(params.next_js){this._on_close=params.next_js;delete params.next_js};if(params.onOpen){this._on_open=params.onOpen;delete params.onOpen};if(params.onTransact){this._on_transact=params.onTransact;delete params.onTransact};if(params.onSoldout){this._on_soldout=params.onSoldout;delete params.onSoldout};if(params.onClose){this._on_close=params.onClose;delete params.onClose};if(params.onResizeOverlay){this._on_resizeoverlay=params.onResizeOverlay;delete params.onResizeOverlay};if(params.auto_hide_flash){this._auto_hide_flash=true;delete params.auto_hide_flash};if(params.position_top){this._positionTop=params.position_top;delete params.position_top};if(params.position_left){this._positionLeft=params.position_left;delete params.position_left};if(params.USER_HOST){if(!host)host=params.USER_HOST;delete params.USER_HOST};delete params.GEO_HOST;if(params.zIndex){zIndex=params.zIndex;delete params.zIndex};if(params.scrolling){scrolling='auto';delete params.scrolling};if(params.dealspot){win_width=640;win_height=644;overlay_type='dotd';delete params.dealspot};if(params.width){win_width=params.width;delete params.width};if(params.height){win_height=params.height;delete params.height}else if(params.fb_item_price)win_height=610;if(params.overlay_type){overlay_type=params.overlay_type;delete params.overlay_type};if(params.hide_close_x||params.tp_hide_chrome){show_close_x=false;delete params.hide_close_x};TRIALPAY._dev._swf_instance_id=false;if(params.swf_instance_id){TRIALPAY._dev._swf_instance_id=params.swf_instance_id;delete params.swf_instance_id};if(params.use_post){use_post=true;delete params.use_post};if(params.tp_hide_chrome)tp_hide_chrome=true};win_width-=18;var frame=window,framedoc=window.document;try{while(!tp_hide_chrome){var parent=frame.parent;if(parent&&parent!=frame){var test=parent.location.href;if(!test)break;frame=parent;framedoc=frame.contentDocument||(frame.contentWindow?frame.contentWindow.document:frame.document)}else break}}catch(e){};if(this._auto_hide_flash)this._set_flash_visibility(true,framedoc);if(!host)host=frame.location.protocol+"//www.trialpay.com";url=host+url;if(url.indexOf('?')<0)url+='?';var iframe_url=url;if(use_post&&!params.skip_odp){iframe_url='//d261sv3xac0f7i.cloudfront.net/fp/blank.gif'}else if(params)for(var key in params)iframe_url+='&'+encodeURIComponent(key)+'='+encodeURIComponent(params[key]);if(params.skip_odp){window.open(iframe_url);return};var body=framedoc.getElementsByTagName("body")[0],width=(frame.innerWidth?frame.innerWidth:framedoc.body.clientWidth),height=(frame.innerHeight?frame.innerHeight:(framedoc.documentElement.clientHeight?framedoc.documentElement.clientHeight:framedoc.body.clientHeight)),scroll_height=framedoc.documentElement.scrollHeight?framedoc.documentElement.scrollHeight:framedoc.body.scrollHeight,scroll_offset_y=(frame.pageYOffset?frame.pageYOffset:(framedoc.documentElement.scrollTop?framedoc.documentElement.scrollTop:framedoc.body.scrollTop)),div_curtain=framedoc.createElement('div'),div=framedoc.createElement('div');if(!tp_hide_chrome){div.style.width=win_width+'px';div.style.position='absolute';div.style.left=(this._positionLeft?this._positionLeft:((width-win_width)/2))+'px';div.style.top=(this._positionTop?this._positionTop:(100+scroll_offset_y))+'px';if(/\WMSIE [678]/.test(navigator.userAgent)){div_curtain.style.cssText='-ms-filter:"progid:DXImageTransform.Microsoft.Alpha(Opacity=70)"; background-color: #fff; filter:alpha(opacity=70);'}else div_curtain.style.backgroundColor='rgba(0, 0, 0, 0.4)';div_curtain.style.top="0";div_curtain.style.left="0";div_curtain.style.width="100%";div_curtain.style.height=scroll_height+"px";div_curtain.style.position='absolute'};if(zIndex){div.style.zIndex=zIndex;div_curtain.style.zIndex=zIndex};var iframe_width=win_width-2,iframe_marker_id='trialpay_20100727_'+(Math.random()*1000),loading_marker_id=iframe_marker_id+'_loading',form_marker_id=iframe_marker_id+'_form',iframe_container_style=(!tp_hide_chrome)?"background: none repeat scroll 0% 0% padding-box rgba(255, 255, 255, 0.98); box-shadow: 0px 3px 8px rgba(0, 0, 0, 0.25); border: 1px solid rgba(100, 100, 100, 0.4); *border-color: rgb(193, 193, 193);":"",html="<div style='"+iframe_container_style+"'><iframe id='"+iframe_marker_id+"' name='"+iframe_marker_id+"' style='border: 0 none white; margin: 0 auto; display: block; width: "+iframe_width+"px; height: "+win_height+"px;' frameborder='0' scrolling='"+scrolling+"' src=\""+iframe_url+"\"></iframe><p id='"+loading_marker_id+"' style='position: absolute; top: 50px; height: 32px; width: 100%; background: transparent url(//d261sv3xac0f7i.cloudfront.net/user/ajax_load.gif) scroll no-repeat top center;)'></p></div>";if(use_post){html+="<form action=\""+url+"\" method=\"POST\" id=\""+form_marker_id+"\" target=\""+iframe_marker_id+"\">";if(params)for(var key in params)html+="<input type=\"hidden\" name=\""+this._esc(key)+"\" value=\""+this._esc(params[key])+"\"/>";html+="</form>"};div.innerHTML=html;TRIALPAY.social._iframe_onload=function(event,loading_marker_id){if(event&&'readystatechange'==event.type&&event.srcElement&&event.srcElement.readyState){var state=event.srcElement.readyState;if('uninitialized'==state||'loading'==state)return};var ele=framedoc.getElementById(loading_marker_id);if(ele)ele.parentNode.removeChild(ele)};TRIALPAY.social.resize_overlay=function(width,height){return TRIALPAY.social._resize_overlay(width,height,frame,framedoc)};if(show_close_x){var div2=this._create_close_button(overlay_type,framedoc);this.add_event(div2,'click',this.bind(this.close_overlay,this));div.appendChild(div2)};var div_wrapper=framedoc.createElement('div');div_wrapper.style.backfaceVisibility='visible';div_wrapper.appendChild(div_curtain);div_wrapper.appendChild(div);this._overlay_div=div_wrapper;body.appendChild(div_wrapper);if(use_post){if(window.console&&console.log)console.log("TP - starting delayed form submitter");var submitFormClosure=function(form_marker_id){var formElement=framedoc.getElementById(form_marker_id),retFunc=function(){if(window.console&&console.log)console.log("TP - doing delayed form submission for: "+form_marker_id);formElement.submit()};return retFunc},submitFormFunc=submitFormClosure(form_marker_id);window.setTimeout(submitFormFunc,1000)};var iframe_loading_marker=framedoc.getElementById(iframe_marker_id);this.add_event(iframe_loading_marker,'load',function(event){TRIALPAY.social._iframe_onload(null,loading_marker_id)});this.add_event(iframe_loading_marker,'readystatechange',function(event){TRIALPAY.social._iframe_onload(event,loading_marker_id)});this.add_event(framedoc,'DOMFrameContentLoaded',function(event){if(!framedoc.getElementById(iframe_marker_id)){TRIALPAY.social.remove_event(framedoc,'DOMFrameContentLoaded',arguments.callee);return};try{if(event.target.id&&iframe_marker_id==event.target.id)TRIALPAY.social._iframe_onload(event,loading_marker_id)}catch(e){}});if(frame.postMessage){TRIALPAY.io.install_post_message_listener(frame)}else TRIALPAY.io.ie7_close_poll(iframe_marker_id);this._call_open_handle();setTimeout("TRIALPAY.social._iframe_onload(null, '"+loading_marker_id+"')",9000)},_create_close_button:function(close_button_type,document){var div2=document.createElement('div');if('dotd'==close_button_type){div2.style.cssText='top: 1px; right: 1px; padding: 2px 5px 3px 7px; margin: 0; -moz-border-radius-bottomleft: 8px; -webkit-border-bottom-left-radius: 8px; border-bottom-left-radius: 8px; background-color: rgb(82,82,82); background-color: rgba(82,82,82,0.7); *background-color: rgb(82,82,82);'}else{div2.style.top='15px';div2.style.right='15px'};div2.style.position='absolute';div2.style.cursor='pointer';div2.style.fontFamily='Tahoma';div2.style.fontWeight='bold';div2.style.fontSize='14px';div2.style.color='#ECEFF6';div2.innerHTML='X';return div2},close_overlay:function(ignore_transactions){if(this._overlay_div){if(this._auto_hide_flash)this._set_flash_visibility(false,this._overlay_div.ownerDocument);this._overlay_div.parentNode.removeChild(this._overlay_div);this._overlay_div=false;this._call_close_handle(false,ignore_transactions)}},_resize_overlay:function(width,height,window,document){var div_wrapper=this._overlay_div;if(!div_wrapper)return;div=div_wrapper.lastChild;var iframe=div.firstChild.firstChild;width=width-0;if(width==-1)width=parseInt(iframe.style.width);if(width>0){var win_width=width+2,screen_width=(window.innerWidth?window.innerWidth:document.body.clientWidth);if("absolute"==div.style.position){if(!this._positionLeft)div.style.left=((screen_width-win_width)/2)+'px';div.style.width=win_width+'px'};iframe.style.width=width+'px'};height=height-0;if(height>0){var win_height=height+2;if("absolute"==div.style.position)div.style.height=win_height+'px';iframe.style.height=height+'px'};if(this._on_resizeoverlay){if(width==0)width=parseInt(iframe.style.width);if(height==0)height=parseInt(iframe.style.height);this._call_handle(this._on_resizeoverlay,width,height)}},call_soldout_handle:function(){this._call_handle(this._on_soldout)},dynamic_api_iframe_test_swf:function(swf_instance_id,offer_id,dynamic_availability_url){TRIALPAY.social.dynamic_api_iframe_test(offer_id,dynamic_availability_url,function(offer_id,message){var tp_payload=("success"==message?true:false);TRIALPAY.io._push_swf_message(swf_instance_id,'trialpayOnDynamicApiIframeResponse',{tp_offer_id:offer_id,tp_payload:tp_payload})})},dynamic_api_iframe_test:function(offer_id,dynamic_availability_url,callback){if(!this.dynamic_availability_callbacks)this.dynamic_availability_callbacks={};this.dynamic_availability_callbacks[offer_id]=callback;TRIALPAY.social.create_availability_iframe("dynamic_api_iframe_"+offer_id,dynamic_availability_url)},dynamic_api_iframe_callback:function(offer_id,message){var div=document.getElementById('dynamic_api_iframe_'+offer_id);div.parentNode.removeChild(div);this.dynamic_availability_callbacks[offer_id](offer_id,message);delete this.dynamic_availability_callbacks[offer_id]},create_availability_iframe:function(id,url){var div=document.createElement('div');div.setAttribute('id',id);div.innerHTML='<iframe style="width: 1px; height: 1px; border: 0px none white; overflow: hidden;" frameborder="0" scrolling="no" src="'+url+'"></iframe>';document.body.appendChild(div)},vast_availability_test_swf:function(swf_instance_id,offer_id,vast_offer_url){TRIALPAY.social.vast_availability_test(offer_id,vast_offer_url,function(offer_id,message){var tp_payload=("success"==message?true:false);TRIALPAY.io._push_swf_message(swf_instance_id,'trialpayOnVastAvailability',{tp_offer_id:offer_id,tp_payload:tp_payload})})},vast_availability_test:function(offer_id,vast_offer_url,callback){if(!this.dynamic_availability_callbacks)this.dynamic_availability_callbacks={};this.dynamic_availability_callbacks[offer_id]=callback;vast_offer_url=vast_offer_url.replace(/%offer_id_encoded%/g,offer_id);vast_offer_url=TRIALPAY.io.http_build_query(vast_offer_url,{availability:1});TRIALPAY.social.create_availability_iframe("vast_availability_"+offer_id,vast_offer_url)},vast_availability_callback:function(offer_id,message){var div=document.getElementById('vast_availability_'+offer_id);div.parentNode.removeChild(div);this.dynamic_availability_callbacks[offer_id](offer_id,message);delete this.dynamic_availability_callbacks[offer_id]},_call_close_handle:function(event,ignore_transactions){if(!ignore_transactions)this._call_transact_handle();this._call_handle(this._on_close)},_call_transact_handle:function(){var swf_instance_id=TRIALPAY._dev._swf_instance_id;if(swf_instance_id)TRIALPAY.social._push_completions(swf_instance_id,'_call_close_handle');this._timestamp_on_close=(new Date()).getTime();if(this._on_transact)if(!this._is_timer_event_queued)this.check_for_completions(false,true)},_timestamp_on_open:0,_timestamp_on_close:0,_is_timer_event_queued:false,_on_transact_callback_on_timeout:true,_call_open_handle:function(params){this._timestamp_on_open=(new Date()).getTime();TRIALPAY._dev.profile('open-handle-start');if(params&&params.expected_seconds_to_transact&&params.expected_seconds_to_transact>0)setTimeout(function(){TRIALPAY.io.log("TrialPay: Triggering the "+params.expected_seconds_to_transact+" second backup check_for_completions call");TRIALPAY.social._on_transact_callback_on_timeout=false;TRIALPAY.social._call_transact_handle()},parseInt(params.expected_seconds_to_transact)*1000);this._call_handle(this._on_open);TRIALPAY._dev.profile('open-handle-done')},_call_handle:function(handle,arg1,arg2,arg3){var ret=undefined;if(handle)try{ret=(typeof (handle)=="string")?eval(handle):handle;if(typeof (ret)=="function")ret=ret.call(window,arg1,arg2,arg3)}catch(e){if(window.console&&window.console.error){window.console.error("TRIALPAY: the following error was caused by a publisher event handler:");window.console.error(e.name+":"+e.message);window.console.error("Error while running code:\n"+handle.toString())};ret=false};return ret},init_overlay:function(vic,sid,params){this._default_vic=vic;this._default_sid=sid;this._default_params=params},get_overlay_param:function(param){if(param=='vic'){return this._default_vic}else if(param=='sid'){return this._default_sid}else if(this._default_params)if(this._default_params[param])return this._default_params[param];return null},check_for_completions:function(arg,check_immediately){this._is_timer_event_queued=false;if(arg&&(arg.completions>0||arg.error)){this._timestamp_on_open=0;this._call_handle(this._on_transact,arg);return};if(this._timestamp_on_open<=0)return;var current_time=(new Date()).getTime();if(!check_immediately){var dur=((this._timestamp_on_close+10000)>current_time)?1000:5000;this._is_timer_event_queued=true;window.setTimeout("TRIALPAY.social.check_for_completions(false, true)",dur);return};if((this._timestamp_on_close+60000)>current_time){var params={jsonp:'TRIALPAY.social.check_for_completions',ts_since:this._timestamp_on_open,ts_current:current_time},clientInstance=TRIALPAY._dev.getClickedClientInstance();if(!clientInstance)clientInstance=TRIALPAY._dev.getLastClientInstance();if(clientInstance){if(clientInstance._params.app_id)params.app_id=clientInstance._params.app_id;if(clientInstance._params.vic)params.vic=clientInstance._params.vic;if(clientInstance._params.is_signed)params.is_signed=1;TRIALPAY.io.inject_script(clientInstance._config['USER_HOST']+'/api/completions/',params)}}else{TRIALPAY.io.log("TrialPay: check_for_completions timed-out while searching for completions");if(this._on_transact_callback_on_timeout){this._timestamp_on_open=0;this._call_handle(this._on_transact,{completions:0,vc_amount:0})}else{TRIALPAY.io.log("TrialPay: onTransact will not be called");this._on_transact_callback_on_timeout=true}}},_push_completions:function(swf_instance_id,source){var clientInstance=TRIALPAY._dev.getClientInstance(swf_instance_id);if(!clientInstance)return;TRIALPAY.io.jsonp(function(completions){completions.source=source;if(clientInstance.isDealspotVersion1()){TRIALPAY.io._push_swf_message(swf_instance_id,'trialpayOnUpdateCompletions2',completions)}else{clientInstance._recordOfferCompletions(completions.completions,'completions');clientInstance._recordOfferCompletions(completions.completions2,'completions2');var source=completions.source,temp_params=clientInstance._params;temp_params.source=source;TRIALPAY.io.ping(clientInstance._config['USER_HOST']+'/msuc/',temp_params);TRIALPAY.io.log('auto refresh after update of user completions');clientInstance.pollData()}},clientInstance._config['USER_HOST']+'/api/completions/ds/?v=1')},add_event:function(ele,name,func){if(ele.addEventListener){ele.addEventListener(name,func,false)}else if(ele.attachEvent)ele.attachEvent("on"+name,func)},remove_event:function(ele,name,func){if(ele.removeEventListener){ele.removeEventListener(name,func,false)}else if(ele.detachEvent)ele.detachEvent("on"+name,func)},bind:function(f,this_obj){return function(){return f.apply(this_obj,arguments)}},record_dealspot_impression:function(url_params){var host=window.location.protocol+"//www.trialpay.com";if(url_params.USER_HOST){host=url_params.USER_HOST;delete url_params.USER_HOST};var url=host+"/mid/?";TRIALPAY.io.ping(url,url_params)}},mobile_dealspot:{render_dealspot:function(options){var config={dealspot_version:options.version,GEO_HOST:options.GEO_HOST?options.GEO_HOST:window.location.protocol+'//geo.tp-cdn.com',USER_HOST:options.USER_HOST?options.USER_HOST:window.location.protocol+'//www.trialpay.com',width:options.width,height:options.height,is_api_mode:0},params={client_instance_id:options.client_instance_id,mode:options.mode,vic:options.vic,sid:options.sid};TRIALPAY._dev.is_loaded(options.app_id,null,config,params,null,'mobile_dealspot')}},js_dealspot:{render_dealspot:function(options){var config={dealspot_version:2,GEO_HOST:options.GEO_HOST?options.GEO_HOST:window.location.protocol+'//geo.tp-cdn.com',USER_HOST:options.USER_HOST?options.USER_HOST:window.location.protocol+'//www.trialpay.com',width:options.width,height:options.height,is_api_mode:options.is_api_mode,img_url:options.img_url?options.img_url:'',hover_img_url:options.hover_img_url?options.hover_img_url:'',onOfferUnavailable:options.onOfferUnavailable?options.onOfferUnavailable:'',onOfferAvailable:options.onOfferAvailable?options.onOfferAvailable:'',onClick:options.onClick?options.onClick:'',onHtmlAsset:options.onHtmlAsset?options.onHtmlAsset:''},params=options;switch(params.mode){case'fbpayments':params.context=4;break;case'tpdirect':params.context=1002;break;case'fbdirect':params.context=1004;break};TRIALPAY._dev.is_loaded(options.app_id,null,config,params,null,'dealspot_swf')}},api_instances:{},dealspot:{display:function(id,options){required_params=['height','width'];for(var i=0;i<required_params.length;i++)if(!options[required_params[i]]){if(window.console&&window.console.error)console.error("TRIALPAY.dealspot.display :: missing required parameter "+required_param[i]);return false};var height=options.height,width=options.width;delete options.height;delete options.width;var content_wrapper_id="trialpay-dealspot-banner-"+Math.round(Math.random()*100000);options.id=content_wrapper_id
function got_flash(){var support=false;if("ActiveXObject" in window){try{support=!!(new ActiveXObject("ShockwaveFlash.ShockwaveFlash"))}catch(e){support=false}}else support=!!navigator.plugins['Shockwave Flash'];return support};var onHtmlAsset=function(html_template,variables,out_img,do_click){do_click=do_click!==undefined?do_click:true;try{var template;if(out_img){template='<img src="'+out_img+'" width="'+width+'" height="'+height+'">'}else if(html_template&&variables){if(options.tp_item_name)variables.tp_item_name=options.tp_item_name;template=html_template;for(var i in variables)template=template.replace(new RegExp('%'+i+'%','g'),variables[i]);for(var i in variables)template=template.replace(new RegExp('%'+i+'%','g'),variables[i])};if(!template){window.console&&console.error&&console.error('TrialPay: onhtmlasset: no image. no template.');return};var wrapper=document.getElementById(id);if(wrapper){wrapper.innerHTML="",wrapper.style.width=parseInt(width)+'px',wrapper.style.height=parseInt(height)+'px',wrapper.style.padding=0,wrapper.style.display='block',wrapper.style.cursor='pointer';var head='<html><head><style type="text/css">*,p,a,span,div,img,body{margin:0;padding:0;border:none;text-decoration:none;cursor:pointer;}</style></head><body><div id="click">',close='</div></body></html>';template=head+template+close;iframe=document.createElement('iframe');iframe.width=width,iframe.height=height,iframe.frameBorder=0,iframe.scrolling='no';wrapper.appendChild(iframe);var inject=function(iframe,template,domain){if(/ Trident\/\d/.test(navigator.userAgent)){if(domain)iframe.src="javascript:(function(){document.open(); document.domain='"+domain+"';}())";var doc=iframe.contentDocument||(iframe.contentWindow?iframe.contentWindow.document:iframe.document);doc.open();doc.writeln(template);doc.close();return};var html=JSON.stringify(template);iframe.src="javascript:(function(html,domain){document.open();if(domain){document.domain=domain;};document.write(html);document.close();}("+html+","+JSON.stringify(domain)+"))"};try{inject(iframe,template)}catch(e){inject(iframe,template,document.domain)};var poll_count=0,setup_click=function(){var iframe_click=false;try{var doc=iframe.contentDocument||(iframe.contentWindow?iframe.contentWindow.document:iframe.document);iframe_click=doc.getElementById('click')}catch(e){inject(iframe,template,document.domain)};if(iframe_click){TRIALPAY.social.add_event(iframe_click,'click',function(){TRIALPAY.api_instances[content_wrapper_id].triggerClick(true)});TRIALPAY.api_instances[content_wrapper_id].recordImpression()}else if(poll_count<=5){poll_count++;setTimeout(setup_click,500)}else{var msg="onhtmlasset::could not attach click handler";if(window.console&&console.error)console.error("TrialPay: "+msg);TRIALPAY.io.ping(location.protocol+'//static.trialpay.com/error/?ec=600',{d:msg})}};if(do_click)setup_click()}else if(window.console&&console.error)console.error('TrialPay: Could not find DOM element with ID: '+id)}catch(e){var message="onhtmlasset::"+e.name+":"+e.message;if(window.console&&console.error)console.error("TrialPay: "+message);TRIALPAY.io.ping(location.protocol+'//static.trialpay.com/error/?ec=600',{d:message})}};if(got_flash()){options.onHtmlAsset=onHtmlAsset;var api=new TRIALPAY.api(options)}else onHtmlAsset('<a href="https://get.adobe.com/flashplayer/" target="_blank"><img src="https://d261sv3xac0f7i.cloudfront.net/store/1177229/1249050302.png" /></a>',{},false,false)}},api:function(options){var sid=options.sid;if(options.tp_params){var tp_params=JSON.parse(options.tp_params);sid=tp_params.sid};if(!options.app_id&&(!options.vic||!sid)){TRIALPAY.io.log('TRIALPAY.api // Error: Please provide a valid app id or vic / sid combo.',true);return};this.options={};for(var i in options)this.options[i]=options[i];TRIALPAY.api.overlayOpen=null;this.impression_fired_ts=null;if(!TRIALPAY.api.init){TRIALPAY.api.init=true;TRIALPAY.social.add_event(window,"message",function(event){if("TRIALPAY.io.event.offerCompleted"==event.data){TRIALPAY.social._call_transact_handle();var api_instance=TRIALPAY._dev._swf_instance_id&&TRIALPAY.api_instances[TRIALPAY._dev._swf_instance_id];if(api_instance&&api_instance.options['preroll'])setTimeout(function(){TRIALPAY.social.close_overlay()},1000)}})};if(options.id){var dsID=this.dsID=options.id;delete options.id}else var dsID=this.dsID="trialpay-dealspot-lite"+Math.round(Math.random()*100000);if(!document.getElementById(this.dsID)){var span=document.createElement('span');span.id=dsID;document.getElementsByTagName('body')[0].appendChild(span)};TRIALPAY.api_instances[dsID]=this;var self=this,params={id:this.dsID,mode:"tpdirect",height:2,width:2},callbacks=['onOfferAvailable','onOfferUnavailable','onOpen','onClose','onTransact','onSoldout','onResizeOverlay','onHtmlAsset'];for(var i=0;i<callbacks.length;i++){params[callbacks[i]]="TRIALPAY.api_instances['"+this.dsID+"']._"+callbacks[i];delete options[callbacks[i]]};if(options.is_api_mode!=undefined){params.is_api_mode=options.is_api_mode}else params.is_api_mode=1;delete options.is_api_mode;if(options.is_js_dealspot!=undefined){var is_js_dealspot=options.is_js_dealspot}else var is_js_dealspot=0;delete options.is_js_dealspot;for(var i in options)params[i]=options[i];if(is_js_dealspot){params.client_instance_id=this.dsID;TRIALPAY.js_dealspot.render_dealspot(params);this.ds=TRIALPAY._dev.getClientInstance(this.dsID)}else{TRIALPAY.social._render_dealspot_swf(params);this.ds=document.getElementById(this.dsID)};self._onOfferAvailable=function(){offer=[];var eligible_offers=self.ds.getEligibleOffers(1,false);for(var offer_key in eligible_offers){var eligible_offer={id:eligible_offers[offer_key]['id'],img:eligible_offers[offer_key]['out_img'],type:eligible_offers[offer_key]['offer_type']};offer.push(eligible_offer);break};TRIALPAY.social._call_handle(self.options.onOfferAvailable,offer)};self._onOfferUnavailable=function(){if(self.options.onOfferUnavailable)TRIALPAY.social._call_handle(self.options.onOfferUnavailable,[])};self._onOpen=function(){TRIALPAY.api.overlayOpen='open_confirmed';if(self.options.onOpen)TRIALPAY.social._call_handle(self.options.onOpen)};self._onClose=function(){TRIALPAY.api.overlayOpen=null;if(self.options.onClose)TRIALPAY.social._call_handle(self.options.onClose)};self._onTransact=function(data){if(self.options.onTransact)TRIALPAY.social._call_handle(self.options.onTransact,data)};self._onSoldout=function(){if(self.options.onSoldout)TRIALPAY.social._call_handle(self.options.onSoldout)};self._onResizeOverlay=function(width,height){if(self.options.onResizeOverlay)TRIALPAY.social._call_handle(self.options.onResizeOverlay,width,height)};self._onHtmlAsset=function(arg1,arg2,arg3){if(self.options.onHtmlAsset)TRIALPAY.social._call_handle(self.options.onHtmlAsset,arg1,arg2,arg3)};self.recordImpression=function(){self.ds.fireImpressionPixel();self.impression_fired_ts=(new Date()).getTime()+500};self.triggerClick=function(force){if(!TRIALPAY.api.overlayOpen||force){if(params.is_api_mode==2){TRIALPAY.api.overlayOpen='open_requested';self.ds.triggerClick()}else if(self.impression_fired_ts&&self.impression_fired_ts<=(new Date()).getTime()){TRIALPAY.api.overlayOpen='open_requested';self.ds.triggerClick()}else TRIALPAY.io.log('TRIALPAY.api // Error: Please call recordImpression() before trying to call triggerClick()',true);if('open_requested'==TRIALPAY.api.overlayOpen)setTimeout(function(){if('open_requested'==TRIALPAY.api.overlayOpen)TRIALPAY.api.overlayOpen=null},1000)}}},_dev:{_is_retargeting_test:false,_is_class_init:false,_is_html5_store:(typeof (Storage)!=="undefined"&&typeof (JSON)!=="undefined")?true:false,_localStoreCache:{},_is_trialpay_ip:0,_clients:{},_clickedClientId:null,_lastClientId:null,clientInstance:function(type,id){var self=this;self._id=id;self._type=type;self._sysconfig={rt:0,mio:0,prof:0,is_trialpay_ip:0,global_refresh_seconds:300,refresh_after_click_seconds:0,fb_demo:0,fb_demo_retries:1,fb_demo_timeout:20,fb_demo_extra:0,dynamic_delay:5,dynamic_post_click_hide_seconds:60,dynamic_post_empty_response_hide_seconds:3600,dynamic_offer_profiling_percentage:0,dynamic_offer_always_profile_errors:0,split_test_configs:{}};self._params={};self._config={GEO_HOST:window.location.protocol+'//geo.tp-cdn.com',STATIC_HOST:window.location.protocol+"//static.trialpay.com",USER_HOST:window.location.protocol+'//www.trialpay.com'};self._fb_demo_retries=1;self._init_time=0;self.profileState=-1;self.profileBuffer=[];self.profileApiRequest=true;self._offers={};self._offer=null;self._is_impression_caps_loop=true;self._item_map=null;self.completionData=null;self.impressionsRecorded={};self._last_impression_offer_id=null;self._dynamic_offer_api_status="not-loaded";self._dynamic_offers={};self._refreshTimerId=null;self._apiRequestDemoPollTimerId=null;self._apiRequestDemoStart=null;self.isTypeDealspotSwf=function(){return self._type=='dealspot_swf'};self.isTypeMobileDealspot=function(){return self._type=='mobile_dealspot'};self.isDealspotVersion1=function(){return self.isTypeDealspotSwf()&&(TRIALPAY._dev.empty(self._config['dealspot_version'])||self._config['dealspot_version']<2)};self.sysconfigRequest=function(){self.profileZynga("swf_sysconfig");var rand=Math.round((new Date()).getTime()/86400000),url=self._config['GEO_HOST']+"/api/config/?service=ds&rand="+rand;self.client_profile('sysconfig-start');TRIALPAY.io.jsonp(self.sysconfigResponseHandler,url,{},self.sysconfigResponseHandler)};self.sysconfigResponseHandler=function(data){try{self.client_profile('sysconfig-done');if(data.error)throw new Error("Unable to load sysconfig: "+data.error+"::"+data.url);for(var key in data){if(key in self._sysconfig)self._sysconfig[key]=data[key];if(key=='is_trialpay_ip')TRIALPAY._dev._is_trialpay_ip=data.is_trialpay_ip};if(!TRIALPAY._dev.empty(self._params['app_id'])){if((self._sysconfig.fb_demo>0)&&(self._sysconfig.fb_demo>=(100*Math.random())))self._sysconfig.fb_demo=101;if(self._sysconfig.rt)TRIALPAY._dev._init_retargeting(self._params['app_id'])}else self._sysconfig.fb_demo=0}catch(error){self.log_error("sysconfigResponseHandler",error.name+"::"+error.message)};self.setupSplitTests();self._sysconfig.prof=((self._sysconfig.prof>0)&&(self._sysconfig.prof>=(100*Math.random())));self.profileState=0;if(self._sysconfig.prof)self.profileState=1;if(self._sysconfig.fb_demo>0)if((self._sysconfig.fb_demo_extra>0)&&(self._sysconfig.fb_demo_extra>=(100*Math.random()))){self._sysconfig.fb_demo_extra=101}else self._sysconfig.fb_demo_extra=0;self.updateOfferDataCount('views');self.updateOfferDataCount('clicks');self.updateOfferDataCount('clicks2');if(self.isTypeDealspotSwf()){var configDataForSWF={_sysconfig:self._sysconfig,_params:self._params};TRIALPAY.io._push_swf_message(self._id,'trialpayOnConfigLoaded',configDataForSWF)};self.pollData();var refreshInterval=self._sysconfig['global_refresh_seconds']*1000;self._refreshTimerId=window.setInterval(function(){TRIALPAY.io.log('auto refresh every '+self._sysconfig['global_refresh_seconds']+' seconds.');self.pollData()},refreshInterval)};self.pollData=function(){try{if(self.isTypeDealspotSwf())TRIALPAY.io._push_swf_message(self._id,'trialpayOnRefreshData',{});self._dynamic_offer_api_status="not-loaded";self._offer=null;self._offers={};self.completionData=null;self.updateOfferDataCount('views');self.updateOfferDataCount('clicks');self.updateOfferDataCount('clicks2');if(self._sysconfig.fb_demo>0){self._fb_demo_retries=self._sysconfig['fb_demo_retries'];if(self._sysconfig['fb_demo_extra']>100)self.log_error("pollData","fb-demo-begin");self.apiRequestDemo()}else self.apiRequest()}catch(error){self.log_error("pollData",error.name+"::"+error.message)}};self.getApiParams=function(){var url="";if(!TRIALPAY._dev.empty(self._params['app_id'])&&!TRIALPAY._dev.empty(self._params['context'])){var context=self._params['context'];if(!TRIALPAY._dev.empty(self._params['touchpoint']))context+=self._params['touchpoint'];url+="fb_app_id="+self._params['app_id']+"&context="+context}else if(!TRIALPAY._dev.empty(self._params['vic']))url+="vic="+self._params['vic'];if(!TRIALPAY._dev.empty(self._params['tp_vendor_id']))url+="&tp_vendor_id="+self._params['tp_vendor_id'];if(!TRIALPAY._dev.empty(self._params['preroll'])){url+="&preroll=1";if("force"==self._params['preroll'])url+="&tp_show_preroll=1"};if(!TRIALPAY._dev.empty(self._params['iso2']))url+="&iso2="+self._params['iso2'];if(!TRIALPAY._dev.empty(self._params['sid'])&&(self._params['mode']=='tpdirect'))url+="&tpi="+self._params['sid'];if(!TRIALPAY._dev.empty(self._params['tp_params']))url+="&tp_params="+encodeURIComponent(self._params['tp_params']);if(!self.isDealspotVersion1()){var sandbox_params=["fb_promotion","game_engagement","age","gender"];TRIALPAY._dev.each(sandbox_params,function(sandbox_param){if(self._params[sandbox_param]!=undefined)url+="&"+encodeURIComponent(sandbox_param)+"="+encodeURIComponent(self._params[sandbox_param])})};if(!TRIALPAY._dev.empty(self._config['banner_template']))url+='&exclude_template=1';if(!TRIALPAY._dev.empty(self._params['currency_url']))url+="&currency_url="+encodeURIComponent(self._params['currency_url']);return url};self.apiRequestDemo=function(){if(self._apiRequestDemoPollTimerId)return;var url=self.getApiParams();TRIALPAY.fb.fetch_offers(url,self._id);var pollInterval=1000;self._apiRequestDemoStart=new Date().getTime();self._apiRequestDemoPollTimerId=window.setInterval(function(){self.apiRequestDemoPoll()},pollInterval)};self.apiRequestDemoPoll=function(){try{var url=self.getApiParams(),offers=TRIALPAY.fb.get_offers(url);if(offers){self._apiRequestDemoPollCancel();if(!offers.offers){self.log_error("apiRequestDemoPoll","no-offers-key::"+url);self.apiRequest({source:'apiRequestDemo'});return};if(self._sysconfig.fb_demo_extra>0)self.log_error("apiRequestDemoPoll","fb-demo-success");self.installNewOfferSet(offers)}}catch(error){self.log_error("apiRequestDemoPoll",error.name+"::"+error.message)};if(self._apiRequestDemoStart){var timeSinceStart=new Date().getTime()-self._apiRequestDemoStart;if(timeSinceStart>self._sysconfig['fb_demo_timeout']*1000){self._apiRequestDemoPollCancel();self.apiRequest()}}};self._apiRequestDemoPollCancel=function(){if(self._apiRequestDemoPollTimerId)window.clearInterval(self._apiRequestDemoPollTimerId);self._apiRequestDemoPollTimerId=null;self._apiRequestDemoStart=null};self.apiRequest=function(event){if(event){var age=Math.round(((new Date()).getTime()-self._init_time)/1000);self.log_error("apiRequest","fb-demo-timeout:"+self._fb_demo_retries+"::"+age);if(self._fb_demo_retries>0){self._fb_demo_retries--;self.apiRequestDemo();return}};var url=self._config['GEO_HOST']+"/api/offers/v1/?";url+=self.getApiParams();if(self.profileApiRequest)self.client_profile('api-start');TRIALPAY.io.jsonp(self.apiLoad,url,{},self.apiLoad)};self.apiLoad=function(data){try{if(!data||data.error){if(data.error)self.log_error("apiRequest",data.error+"::"+data.url);self.dispatchOfferUnavailable();return};if(self.profileApiRequest){self.profileApiRequest=false;self.client_profile('api-done')};self.installNewOfferSet(data)}catch(e){self.log_error("apiLoad",e.name+"::"+e.message)}};self.apiRequestDynamicOffer=function(event){self._dynamic_offer_api_status="loading";var wait=false,key;for(key in self._offers){var offer=self._offers[key],id=offer.id;if(!offer.is_dynamic_api)continue;var dynamic_offer=self._dynamic_offers[id];if(!dynamic_offer){dynamic_offer=new Object();self._dynamic_offers[id]=dynamic_offer};delete dynamic_offer.tp_payload;delete dynamic_offer.tp_aes_iv;delete dynamic_offer.url;delete dynamic_offer.dispatch_ts;delete dynamic_offer.response_ts;delete dynamic_offer.ec;delete dynamic_offer.response;if(dynamic_offer.hide_until_timestamp){if(dynamic_offer.hide_until_timestamp>(new Date()).getTime())continue;delete dynamic_offer.hide_until_timestamp};var url=self._config.is_https?offer.dynamic_api_surl:offer.dynamic_api_url;if(!url||url.length<1){TRIALPAY.io.log("api offer: "+offer.id+" does not have an appropriate API url, skipping.");continue};if(!(/\?/.test(url)))url+='?';url+="&tp_offer_id="+id;url+="&tp_payload="+encodeURIComponent(offer.tp_payload);url+="&tp_aes_iv="+encodeURIComponent(offer.tp_aes_iv);var apiDynamicCallback=function(offer_id){return function(data){self.apiRequestDynamicOfferLoad(offer_id,data)}};TRIALPAY.io.jsonp(apiDynamicCallback(id),url,{},apiDynamicCallback(id));dynamic_offer.url=url;dynamic_offer.dispatch_ts=(new Date()).getTime();wait=true};if(wait){var timeout=self._sysconfig['dynamic_delay']*1000;window.setTimeout(function(event){self._dynamic_offer_api_status="loaded";self.findNextOffer();var midp_rows=new Object(),midp_rows_exist=false,midp_profiling_enabled=false;if(self._sysconfig.dynamic_offer_profiling_percentage>=(100*Math.random())){self._sysconfig.dynamic_offer_profiling_percentage=101;midp_profiling_enabled=true}else self._sysconfig.dynamic_offer_profiling_percentage=0;var new_hide_until_timestamp=(new Date()).getTime()+(1000*self._sysconfig['dynamic_post_empty_response_hide_seconds']);for(key in self._dynamic_offers){var dynamic_offer=self._dynamic_offers[key];if(!dynamic_offer.tp_payload&&dynamic_offer.dispatch_ts)if(dynamic_offer.hide_until_timestamp){dynamic_offer.hide_until_timestamp=Math.max(new_hide_until_timestamp,dynamic_offer.hide_until_timestamp)}else dynamic_offer.hide_until_timestamp=new_hide_until_timestamp;if(!midp_profiling_enabled&&!self._sysconfig.dynamic_offer_always_profile_errors)continue;var midp_row=new Object();if(dynamic_offer.url)midp_row.url=dynamic_offer.url;if(dynamic_offer.dispatch_ts){if(dynamic_offer.response_ts){if(dynamic_offer.ec){midp_row.ec=dynamic_offer.ec}else if(!midp_profiling_enabled)continue;midp_row.ms=dynamic_offer.response_ts-dynamic_offer.dispatch_ts;if(dynamic_offer.response)midp_row.response=dynamic_offer.response}else midp_row.ec="No valid response"}else midp_row.ec="Request was not sent";midp_rows[key]=midp_row;midp_rows_exist=true};if(midp_rows_exist){var params={fb_app_id:self._params['app_id'],vic:self._params['vic'],context:self._params['context'],sid:self._params['sid'],tp_ts:(new Date()).getTime(),data:TRIALPAY.JSON.encode(midp_rows)};TRIALPAY.io.ping(self._config['USER_HOST']+'/midp/',params)}},timeout)}else{self._dynamic_offer_api_status="loaded";self.findNextOffer()}};self.apiRequestDynamicOfferLoad=function(key,data){var response='',response_ts=(new Date()).getTime(),dynamic_offer=self._dynamic_offers[key];dynamic_offer.response_ts=response_ts;try{if(!data.error){response=data;var result=response;if(result.tp_offer_id){if(result.tp_offer_id!=key){dynamic_offer.ec="tp_offer_id does not match expected value"}else if(result.tp_payload){dynamic_offer.tp_payload=result.tp_payload;dynamic_offer.tp_aes_iv=result.tp_aes_iv}}else dynamic_offer.ec="missing tp_offer_id"}else{var text=data.error+'::'+data.url;self.log_error("apiRequestDynamicOfferLoad","dynamic offer provider error - "+text);dynamic_offer.ec='dynamic offer request error - '+text};dynamic_offer.response=response}catch(error){self.log_error("apiRequestDynamicOfferLoad",error.name+"::"+error.message+"::"+response.substr(0,255));dynamic_offer.ec="dynamic offer exception - "+error.name;dynamic_offer.response=response}};self.installNewOfferSet=function(result){if(result.tp_user_payload&&result.tp_user_aes_iv){self._params['tp_user_payload']=result.tp_user_payload;self._params['tp_user_aes_iv']=result.tp_user_aes_iv};if(!result.offers||(result.offers.length==0)){self.dispatchOfferUnavailable();return};self._offers=result.offers;if(result.is_impression_caps_loop)self._is_impression_caps_loop=(result.is_impression_caps_loop!=0);if((result.show_percent!=undefined)&&(result.show_percent<100))if(Math.floor(Math.random()*101)>result.show_percent){self.dispatchOfferUnavailable();return};if(self._params['tp_item_map']){if(!self._item_map){self.dispatchOfferUnavailable();TRIALPAY.io.log("Invalid tp_item_map",true);return};var tp_item_map_required_params=["tp_item_name"],required_param_key,required_param;if(result.tp_item_map_required_params)for(var i=0;i<result.tp_item_map_required_params.length;i++){required_param=result.tp_item_map_required_params[i];tp_item_map_required_params.push(required_param)};TRIALPAY._dev.each(self._item_map,function(item_mapping,key){for(var i=0;i<tp_item_map_required_params.length;i++){required_param=tp_item_map_required_params[i];if(!item_mapping[required_param]){self.dispatchOfferUnavailable();TRIALPAY.io.log("Invalid tp_item_map",true);return}}})};self.findNextOffer()};self.fireImpressionPixel=function(){var offer_id=!self._offer?'no_offers_available':self._offer['id'],is_eligible_visitor=!self._offer?0:1,params={fb_app_id:(self._params['app_id'])?(self._params['app_id']):'',vic:(self._params['vic'])?self._params['vic']:'',context:(self._params['context'])?self._params['context']:'',sid:(self._params['sid'])?self._params['sid']:'',tp_ts:(new Date()).getTime(),tp_user_payload:(self._params['tp_user_payload'])?self._params['tp_user_payload']:'',tp_user_aes_iv:(self._params['tp_user_aes_iv'])?self._params['tp_user_aes_iv']:''};if(!TRIALPAY._dev.empty(self._params['touchpoint']))params.context+=self._params['touchpoint'];if(is_eligible_visitor>0&&!self._offer['is_fallback']){if((self._sysconfig['mio']>0)&&(!self.impressionsRecorded[offer_id])){params.oid=offer_id;TRIALPAY.io.ping(self._config['USER_HOST']+'/mio/',params);delete params.oid};if(offer_id!=self._last_impression_offer_id)self.incrementOfferDataCount('views',offer_id,self._offer['max_views_days'])};var numImpressionsRecorded=0;for(var key in self.impressionsRecorded)numImpressionsRecorded++;if(numImpressionsRecorded==0){params.is_ev=is_eligible_visitor;TRIALPAY.io.ping(self._config['USER_HOST']+'/mid/',params)};self.impressionsRecorded[offer_id]=true;self._last_impression_offer_id=offer_id};self.findNextOffer=function(reset_impression_caps_on_offer_unavailable){reset_impression_caps_on_offer_unavailable=(typeof reset_impression_caps_on_offer_unavailable!=='undefined')?reset_impression_caps_on_offer_unavailable:true;self._offer=null;var eligibleOffers=self.getEligibleOffers(1,true);if("loading"==self._dynamic_offer_api_status)return;for(var key in eligibleOffers){self._offer=eligibleOffers[key];break};if(self._offer==null){if(self._is_impression_caps_loop&&reset_impression_caps_on_offer_unavailable){for(var i=0;i<self._offers.length;i++){var _offer=self._offers[i];self.clearOfferDataCount('views',_offer.id)};self.findNextOffer(false)}else self.dispatchOfferUnavailable()}else self.dispatchOfferAvailable()};self.getEligibleOffers=function(maxOfferCount,log){maxOfferCount=typeof (maxOfferCount)!=='undefined'?maxOfferCount:0;log=typeof (log)!=='undefined'?log:false;var logMessage=[],eligibleOfferCount=0,eligibleOffers={};try{if(self._offers==null)return eligibleOffers;for(i in self._offers){var offer=self._offers[i];if(!offer)continue;var isEligible=true,offerHasAssets=!TRIALPAY._dev.empty(self.getOfferImgUrl(offer))||!TRIALPAY._dev.empty(offer.template),offerViewCount=self.getOfferDataCount('views',offer.id),offerClickCount=self.getOfferDataCount('clicks',offer.id),offerClickCount2=self.getOfferDataCount('clicks2',offer.id),offerCompletionCount=self._getOfferCompletionHistory(offer.id,'completions',offer.limit_days),offerCompletionCount2=self._getOfferCompletionHistory(offer.id,'completions2',offer.limit_days2),logObj={rank:i+1,offer_id:offer.id,assets:offerHasAssets,impressions:offerViewCount+" / "+offer.max_views,clicks:offerClickCount+" / "+offer.max_clicks,clicks2:offerClickCount2+" / "+offer.max_clicks2,completions:offerCompletionCount+" / "+(offer.limit==2147483647?0:offer.limit),completions2:offerCompletionCount2+" / "+(offer.limit2==2147483647?0:offer.limit2),shown:"no"};if(offer.max_views&&(offer.max_views>0)&&(offerViewCount>=offer.max_views)&&(self._last_impression_offer_id!=offer.id))isEligible=false;if(offer.max_clicks&&(offer.max_clicks>0)&&(offerClickCount>=offer.max_clicks))isEligible=false;if(offer.max_clicks2&&(offer.max_clicks2>0)&&(offerClickCount2>=offer.max_clicks2))isEligible=false;if((offer.limit>0)&&(offerCompletionCount>=offer.limit))isEligible=false;if((offer.limit2>0)&&(offerCompletionCount2>=offer.limit2))isEligible=false;if(!offerHasAssets)isEligible=false;if(isEligible&&offer.is_dynamic_api){isEligible=false;if("not-loaded"==self._dynamic_offer_api_status){self._dynamic_offer_api_status="loading";logObj.shown="init";window.setTimeout(self.apiRequestDynamicOffer,1)}else if("loaded"==self._dynamic_offer_api_status){var dynamic_offer=self._dynamic_offers[offer.id];if(dynamic_offer&&dynamic_offer.tp_payload)isEligible=true}};if(isEligible){eligibleOffers[i]=offer;if(eligibleOfferCount++==0)logObj.shown="yes"};logMessage.push(logObj);if((maxOfferCount>0)&&(maxOfferCount==eligibleOfferCount))break};if(log){TRIALPAY.io.log('_last_impression_offer_id = '+self._last_impression_offer_id);TRIALPAY.io.log_table(logMessage,[{property:'rank',length:4,label:'Rank'},{property:'offer_id',length:8,label:'Offer Id'},{property:'assets',length:6,label:'Assets'},{property:'impressions',length:11,label:'Impressions'},{property:'clicks',length:6,label:'Clicks'},{property:'clicks2',length:7,label:'Clicks2'},{property:'completions',length:11,label:'Completions'},{property:'completions2',length:12,label:'Completions2'},{property:'shown',length:5,label:'Shown'}])}}catch(error){self.log_error("getEligibleOffers",error.name+"::"+error.message)};return eligibleOffers};self.getOfferImgUrl=function(offer){if(!TRIALPAY._dev.empty(self._config['img_url']))return self._config['img_url'];if(self._item_map)if(self._item_map[offer.id]){if(self._item_map[offer.id]['img_url'])return self._item_map[offer.id]['img_url']}else if(self._item_map['default']&&self._item_map['default']['img_url'])return self._item_map['default']['img_url'];return offer.out_img};self.onClick=function(offer){var excludes=["vic","app_id","mode"];if(self._params['mode']=='fbpayments'){excludes.push("tp_user_payload");excludes.push("tp_user_aes_iv")};if(self.profileState<=0){excludes.push("puid")}else if(self.profileState==1)self.profileState=2;var outputParams={};TRIALPAY._dev.each(self._params,function(value,param){if(!TRIALPAY._dev.in_array(param,excludes))outputParams[param]=value});if(!TRIALPAY._dev.empty(offer.offer_type)&&(offer.offer_type=='category'))outputParams.is_category=1;if(self._params['mode']=='fbpayments'){var content_width=620;if(!TRIALPAY._dev.empty(offer.offer_type)&&(offer.offer_type=='video'))content_width=760;outputParams.width=content_width}else if(!TRIALPAY._dev.empty(offer.offer_type)&&(offer.offer_type=='video')&&(self._params['context']!=1100)){outputParams.width=700}else{outputParams.width=640;outputParams.height=459};outputParams.USER_HOST=self._config['USER_HOST'];outputParams.oid=offer.id;var dynamic_offer=self._dynamic_offers[offer.id];if(dynamic_offer&&dynamic_offer.tp_payload){outputParams.tp_payload=dynamic_offer.tp_payload;outputParams.tp_aes_iv=dynamic_offer.tp_aes_iv;if(self._sysconfig['dynamic_post_click_hide_seconds']&&(self._sysconfig['dynamic_post_click_hide_seconds']>0))dynamic_offer.hide_until_timestamp=(new Date()).getTime()+(1000*self._sysconfig['dynamic_post_click_hide_seconds'])};var disableOverlay=false;if(!TRIALPAY._dev.empty(self._config['onClick'])){var ret=TRIALPAY.social._call_handle(self._config['onClick'],outputParams);if(ret===false)disableOverlay=true};if(self.isTypeMobileDealspot)disableOverlay=true;if(!disableOverlay){self.client_profile('click');if(!TRIALPAY._dev.empty(self._params['app_id'])){TRIALPAY.fb.show_overlay(self._params['app_id'],self._params['mode'],outputParams)}else TRIALPAY.social.show_overlay(self._params['vic'],self._params['sid'],outputParams)};self.incrementOfferDataCount('clicks',offer.id,offer.max_clicks_days);self.incrementOfferDataCount('clicks2',offer.id,offer.max_clicks_days2);self._last_impression_offer_id=null;TRIALPAY.io.log('manual refresh after click');self.pollData();if(self._sysconfig['refresh_after_click_seconds']>0){var refreshTimeout=self._sysconfig['refresh_after_click_seconds']*1000;window.setTimeout(function(){TRIALPAY.io.log('auto refresh '+self._sysconfig['refresh_after_click_seconds']+' seconds after click.');self.pollData()},refreshTimeout)}};self.dispatchOfferUnavailable=function(){if(self._config['is_api_mode']===0||self._config['is_api_mode']===1)self.fireImpressionPixel();if(self.isTypeDealspotSwf())TRIALPAY.io._push_swf_message(self._id,'trialpayOnOfferUnavailable',{});if(!TRIALPAY._dev.empty(self._config['onOfferUnavailable']))window.setTimeout(function(){TRIALPAY.social._call_handle(self._config['onOfferUnavailable'])},1)};self.dispatchOfferAvailable=function(){if(!self._offer)return;var offer_id=self._offer['id'],raiseEvent=false;if(!self.impressionsRecorded[offer_id]||!self._last_impression_offer_id){raiseEvent=true;if(self._config['is_api_mode']===0)self.fireImpressionPixel()};if(self.isTypeDealspotSwf()){var message={offer:self._offer,raiseEvent:raiseEvent};TRIALPAY.io._push_swf_message(self._id,'trialpayOnOfferAvailable',message)}else if(self.isTypeMobileDealspot()){var body=document.body;body.style.background='transparent';body.style.margin=0;body.style.padding=0;body.style.border=0;var newContainer=document.createElement('div');newContainer.setAttribute('id','trialpay_dealspot_container');TRIALPAY.social.add_event(newContainer,'click',function(){self.onClick(self._offer)});if(!self._config['width'])self._config['width']=50;if(!self._config['height'])self._config['height']=50;var dealspot_link=document.createElement('a'),ds_base_url='trialpay://dsresizefull:'+self._config['USER_HOST']+'/dispatch/'+self._params['vic'],ds_url_params={sid:self._params['sid'],oid:self._offer['id']},ds_link_location=TRIALPAY.io.http_build_query(ds_base_url,ds_url_params);dealspot_link.setAttribute('href',ds_link_location);dealspot_link.className="dealspot_link";dealspot_link.setAttribute('target',"_blank");var dealspot_img=new Image();dealspot_img.src=self._offer.out_img;dealspot_img.style.width=self._config['width'];dealspot_img.style.height=self._config['height'];dealspot_link.appendChild(dealspot_img);newContainer.appendChild(dealspot_link);var container=document.getElementById('trialpay_dealspot_container');if(container===null){body.appendChild(newContainer)}else container.parentNode.replaceChild(newContainer,container);window.location="trialpay://dsresizetouchpoint"};if(raiseEvent){if(!TRIALPAY._dev.empty(self._config['onOfferAvailable']))window.setTimeout(function(){TRIALPAY.social._call_handle(self._config['onOfferAvailable'])},1);if((!TRIALPAY._dev.empty(self._offer['template'])||!TRIALPAY._dev.empty(self._offer['out_img']))&&!TRIALPAY._dev.empty(self._config['onHtmlAsset']))window.setTimeout(function(){TRIALPAY.social._call_handle(self._config['onHtmlAsset'],self._offer['template'],null,self._offer['out_img'])},1)}};self.setupSplitTests=function(){var _params=self._params,split_test_configs=self._sysconfig.split_test_configs,split_test_cookie=TRIALPAY._dev.retrieveData('split_test_cookie'),cookie_key='',param_key_to_change='';if(split_test_cookie==null)split_test_cookie={};if(_params.vic&&split_test_configs[_params.vic]){cookie_key=_params.vic;param_key_to_change='vic'};if(_params.app_id&&_params.context){cookie_key=_params.app_id+(':'+_params.context)+_params.touchpoint;param_key_to_change='touchpoint'};if(split_test_configs[cookie_key])if(typeof (split_test_cookie[cookie_key])!=="undefined"&&TRIALPAY._dev.in_object(split_test_cookie[cookie_key],split_test_configs[cookie_key])){_params[param_key_to_change]=split_test_cookie[cookie_key]}else{var test_channel=self._selectTestChannel(split_test_configs[cookie_key]);if(!test_channel||test_channel==='0')test_channel='';split_test_cookie[cookie_key]=_params[param_key_to_change]=test_channel};TRIALPAY._dev.storeData('split_test_cookie',split_test_cookie)};self._selectTestChannel=function(channels){var r=Math.floor(channels.length*Math.random());return channels[r]};self.client_profile=function(event_name,time_stamp){if(self.profileState==0)return;if(!time_stamp)time_stamp=(new Date()).getTime();self.profileBuffer.push({en:event_name,ts:time_stamp});if(self.profileState<2)return;TRIALPAY._dev.each(self.profileBuffer,function(params){self.profile(params.en,params.ts)});self.profileBuffer=[]};self.profile=function(event_name,time_stamp){if(!self._sysconfig.prof)return;if(!time_stamp)time_stamp=(new Date()).getTime();var params={en:event_name,ts:time_stamp,puid:self._params.puid};if(self._params.app_id)params.app_id=self._params.app_id;if(self._params.vic)params.vic=self._params.vic;if(self._params.context)params.context=self._params.context+"";if(self._params.touchpoint)params.context+=self._params.touchpoint;TRIALPAY.io.ping(self._config['USER_HOST']+'/mip/?',params)};self.profileZynga=function(event){if(TRIALPAY._dev.in_array(self._params['app_id'],['291549705119','342684208824','130409810307796','144959615576466']))TRIALPAY.io.ping(self._config['USER_HOST']+"/mz/?app_id="+self._params['app_id']+"&ev="+event+"&rand="+(new Date()).getTime())};self.getOfferDataCount=function(key,subkey){key=self._buildOfferDataKey(key);var counts=TRIALPAY._dev.retrieveData(key);if((counts==null)||(typeof (counts[subkey])=='undefined'))return 0;if(typeof (counts[subkey])!='object'){counts[subkey]=[];TRIALPAY._dev.storeData(key,counts)};var now=Math.floor(new Date().getTime()/1000),count=0;for(var i=0;i<counts[subkey].length;i++)if(counts[subkey][i]>now)count++;return count};self.updateOfferDataCount=function(key){key=self._buildOfferDataKey(key);var counts=TRIALPAY._dev.retrieveData(key);if(counts==null)return;var new_counts={},now=Math.floor(new Date().getTime()/1000);TRIALPAY._dev.each(counts,function(timestamps,subkey){new_counts[subkey]=[];TRIALPAY._dev.each(timestamps,function(timestamp){if(now<timestamp)new_counts[subkey].push(timestamp)})});TRIALPAY._dev.storeData(key,new_counts)};self.incrementOfferDataCount=function(key,subkey,days_until_expiration){var days_until_expiration=typeof (days_until_expiration)!=='undefined'?days_until_expiration:0;key=self._buildOfferDataKey(key);var counts=TRIALPAY._dev.retrieveData(key);if(!counts)counts={};if(typeof (counts[subkey])!='object')counts[subkey]=[];if(days_until_expiration==0)days_until_expiration=365;counts[subkey].push(Math.floor((new Date().getTime()/1000)+(days_until_expiration*86400)));TRIALPAY._dev.storeData(key,counts)};self.clearOfferDataCount=function(key,subkey){key=self._buildOfferDataKey(key);var counts=TRIALPAY._dev.retrieveData(key);if(counts==null)return;if(typeof (counts[subkey])=='undefined')return;counts[subkey]=[];TRIALPAY._dev.storeData(key,counts)};self._buildOfferDataKey=function(key){if((self._params['mode']=='tpdirect')&&(self._params['context']!=1100))key+='-'+self._params['sid'];return key};self._recordOfferCompletions=function(completions,bucket){try{TRIALPAY._dev.storeData(bucket,completions)}catch(error){self.log_error("_recordOfferCompletions",error.name+"::"+error.message)}};self._getOfferCompletionHistory=function(offer_id,bucket,lookback_days){var lookback_days=typeof (lookback_days)!=='undefined'?lookback_days:2147483647;try{if(self.completionData==null)self.completionData={};if(typeof (self.completionData[bucket])=='undefined'||self.completionData[bucket]==null){var rawData=TRIALPAY._dev.retrieveData(bucket);self.completionData[bucket]={};if(!TRIALPAY._dev.empty(rawData)){rawData=rawData.split("-").join("+");rawData=rawData.split("_").join("/");if(rawData.length%4!=0)rawData+="====".substr(0,rawData.length%4);self.completionData[bucket]=eval('['+TRIALPAY.Base64.base64_decode(rawData)+']').pop()}};switch(typeof (self.completionData[bucket][offer_id])){case'number':return self.completionData[bucket][offer_id];break;case'object':if((lookback_days!=2147483647)&&(self.completionData[bucket][offer_id][1]!='undefined')){var expire_date=self.completionData[bucket][offer_id][1]+(lookback_days*86400);expire_date=expire_date-((expire_date-18000)%86400);var current_date=Math.ceil(((new Date()).getTime())/1000);if(current_date<expire_date)return self.completionData[bucket][offer_id][0]};break;case'undefined':default:}}catch(error){self.log_error("_getOfferCompletionHistory",error.name+"::"+error.message)};return 0};self.log_error=function(func,message){var url=self._config['STATIC_HOST']+"/error/",url_params={ec:600,d:func+'::'+message};TRIALPAY.io.ping(url,url_params)}},getClientInstance:function(client_id){if(!client_id)return false;return this._clients[client_id]},getClickedClientInstance:function(){if(!this._clickedClientId)return false;return this._clients[this._clickedClientId]},getLastClientInstance:function(){if(!this._lastClientId)return false;return this._clients[this._lastClientId]},createClientInstance:function(client_type,client_id,params){if(!client_id)return false;var clientInstance=new this.clientInstance(client_type,client_id);this._clients[client_id]=clientInstance;this._lastClientId=client_id;if(params)for(var i in clientInstance._config)if(params[i])clientInstance._config[i]=params[i];return clientInstance},_init_retargeting:function(app_id){if(this._is_class_init)return;this._is_class_init=true;if(/\WMSIE\W/.test(navigator.userAgent))switch(app_id){case'127148832824':case'134920244184':case'31231052697':case'339444600959':this._is_retargeting_test=(new Date()).getTime()+5000;this._install_rt_lib()}},_install_rt_lib:function(){if(false===TRIALPAY._dev._is_retargeting_test)return;if(document.body){var script=document.createElement("SCRIPT");script.setAttribute("type","text/javascript");script.setAttribute("src",('https:'==window.location.protocol?"https://s-assets.":"http://assets.")+"tp-cdn.com/static3/js/singles/rt.js");document.body.appendChild(script)}else window.setTimeout(TRIALPAY._dev._install_rt_lib,500)},is_loaded:function(app_id,sysconfig,config,params,lsoData,client_instance_type){try{return this._is_loaded(app_id,sysconfig,config,params,lsoData,client_instance_type)}catch(e){var message="is_loaded::"+e.name+":"+e.message;if(window.console&&console.error)console.error("TrialPay: "+message);TRIALPAY.io.ping(location.protocol+'//static.trialpay.com/error/?ec=600',{d:message})};return false},_is_loaded:function(app_id,sysconfig,config,params,lsoData,client_instance_type){var instance_type='dealspot_swf';if(client_instance_type)instance_type=client_instance_type;var client_id=params.swf_instance_id||params.client_instance_id;if(!client_id){TRIALPAY.io.log("Invalid params :: no swf_instance_id",true);return false};var client=this.createClientInstance(instance_type,client_id);if(sysconfig){client._sysconfig=sysconfig;if(sysconfig.rt)TRIALPAY._dev._init_retargeting(params.app_id);if('is_trialpay_ip' in sysconfig)TRIALPAY._dev._is_trialpay_ip=sysconfig.is_trialpay_ip};if(config)client._config=config;if(params)client._params=params;if(params.onTransact)TRIALPAY.social._on_transact=params.onTransact;if(this._is_retargeting_test){if(TRIALPAY.retargeting)return true;var current=(new Date()).getTime();if(current<this._is_retargeting_test)return false;this._is_retargeting_test=false};if(!client.isDealspotVersion1()){client._init_time=0;this.initLocalStoreCache();if(lsoData)this.updateLocalStoreCache(lsoData);try{client._item_map=eval(params.tp_item_map)}catch(error){TRIALPAY.io.log(error.name+"::"+error.message+"::"+params.tp_item_map,true)};client.sysconfigRequest()};return true},onClick:function(client_id,offer){var client=this.getClientInstance(client_id);if(client){this._clickedClientId=client_id;client.onClick(offer)}},storeData:function(key,value){this._localStoreCache[key]=value;var swfClient=false;for(var client_id in this._clients)if(this._clients[client_id].isTypeDealspotSwf()&&!this._clients[client_id].isDealspotVersion1()){swfClient=this._clients[client_id];break};if(swfClient){TRIALPAY.io.lsoPut(swfClient._id,key,value);TRIALPAY.io.storePut(key,value)}else if(this._is_html5_store)TRIALPAY.io.storePut(key,value)},retrieveData:function(key){return this._localStoreCache[key]},initLocalStoreCache:function(){if(!this._is_html5_store)return;for(var key in localStorage)this._localStoreCache[key]=TRIALPAY.io.storeGet(key)},updateLocalStoreCache:function(data){var self=this;TRIALPAY._dev.each(data,function(val,key){self._localStoreCache[key]=val;TRIALPAY.io.storePut(key,val)})},empty:function(s){return(s==''||s==null)?true:false},each:function(data,fn,bind){var type=typeof (data);if(type=='arguments'||type=='collection'||type=='array'||type=='elements'){for(var i=0;i<data.length;i++)fn.call(bind,data[i],i)}else for(var key in data)fn.call(bind,data[key],key)},in_array:function(needle,haystack){var itemIndex=haystack.indexOf(needle);return(itemIndex<0)?false:true},in_object:function(needle,haystack){for(var k in haystack)if(haystack[k]===needle)return true;return false},client_profile:function(client_id,event_name,time_stamp){var clientInstance=this.getClientInstance(client_id);if(!clientInstance)return;clientInstance.client_profile(event_name,time_stamp)},profile:function(event_name,time_stamp){var clientInstance=this.getClickedClientInstance();if(!clientInstance)clientInstance=this.getLastClientInstance();if(!clientInstance)return;clientInstance.profile(event_name,time_stamp)},get_touchpoint:function(app_id){if(TRIALPAY._dev._is_retargeting_test&&TRIALPAY.retargeting)return TRIALPAY.retargeting.get_touchpoint(app_id);return 0}},JSON:{_escape_str:function(str){return'"'+str.replace(/\\|"/g,'\\$&').replace(/\n/g,'\\n').replace(/\r/g,'\\r')+'"'},encode:function(obj){if(null===obj)return"null";var type=typeof (obj),json;switch(type){case"number":json=obj;break;case"string":json=this._escape_str(obj);break;case"boolean":json=obj?"true":"false";break;case"object":var serialize=[];if(obj instanceof Array){for(var key=0;key<obj.length;key++)serialize.push(this.encode(obj[key]));json="["+serialize.join(",")+"]"}else{for(var key in obj)serialize.push(this._escape_str(key)+":"+this.encode(obj[key]));json="{"+serialize.join(",")+"}"};break;case"undefined":default:json="undefined";break};return json}},Base64:{base64_decode:function(string){var cb64="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/=",result="",_in=[null,null,null,null],_out=[null,null,null];for(var i=0;i<string.length;i+=4){for(var j=0;(j<4)&&(i+j<string.length);j++)_in[j]=cb64.indexOf(string.charAt(i+j));_out[0]=(_in[0]<<2)+((_in[1]&0x30)>>4);_out[1]=((_in[1]&0x0f)<<4)+((_in[2]&0x3c)>>2);_out[2]=((_in[2]&0x03)<<6)+_in[3];for(var k=0;k<3;k++){if(_in[k+1]==64)break;result+=String.fromCharCode(_out[k])}};return result}},io:{ie7_close_poll:function(iframe_marker_id){var poll=function(){var iframe=document.getElementById(iframe_marker_id);if(iframe)if(iframe.contentWindow.frames.length>=4){TRIALPAY.social.close_overlay()}else window.setTimeout(poll,250)};if(/\WMSIE [67]/.test(navigator.userAgent))poll()},ping:function(url,url_params){url=this.http_build_query(url,url_params);var image=new Image();image.src=url},log:function(data,force){if(!force&&TRIALPAY._dev._is_trialpay_ip==0)return;if(window.console&&window.console.log)window.console.log(data)},log_table:function(rows,columns){var lpad=function(str,length){if(str.length<length){str="                          "+str;str=str.substr(-length)};return str};if(!window.console)return;if(console.table){console.table(rows)}else{var table=[],row=[];for(var i=0;i<columns.length;i++)row.push(lpad(columns[i].label,columns[i].length));row=row.join(" | ");table.push(row);for(var j=0;j<rows.length;j++){var row=[];for(var i=0;i<columns.length;i++){var value=rows[j][columns[i].property]+"";row.push(lpad(value,columns[i].length))};row=row.join(" | ");table.push(row)};table="| "+table.join(" |\n| ")+" |";this.log(table)}},http_build_query:function(url,url_params){if(url_params){var skip_amp=false;if(url.indexOf('?')<0){url+='?';skip_amp=true}else if(url.indexOf('?')==url.length-1)skip_amp=true;for(var i in url_params){url+=(skip_amp?"":"&")+encodeURIComponent(i)+"="+encodeURIComponent(url_params[i]);skip_amp=false}};return url},parse_str:function(str){var result={},pairs=str.split("&");for(var i=0;i<pairs.length;i++){var pair=pairs[i].split("=");result[decodeURIComponent(pair[0])]=decodeURIComponent(pair[1])};return result},jsonp:function(callback,url,url_params,error_callback,timeout_seconds){var self=this.jsonp;if(!self.cache){self.cache={};self.count=0};var unique_id="j"+ self.count++;self.cache[unique_id]=function(param){delete self.cache[unique_id];callback(param)};var on_error=false;if(error_callback){if(!timeout_seconds)timeout_seconds=10;on_error=function(ev,error){if(self.cache[unique_id]){delete self.cache[unique_id];error=error||{error:'script error'};error.url=url;error.url_params=url_params;error_callback(error)}};setTimeout(function(){on_error(null,{error:'timeout',timeout_seconds:timeout_seconds})},timeout_seconds*1000)};url_params=url_params||{};url_params.jsonp="TRIALPAY.io.jsonp.cache."+unique_id;this.inject_script(url,url_params,on_error)},inject_script:function(url,url_params,error_callback){url=this.http_build_query(url,url_params);var helper=function(){var element=document.getElementsByTagName("HEAD");if(element&&element.length&&element.length>0){element=element[0]}else element=document.body;if(element){var script=document.createElement("SCRIPT");script.setAttribute("type","text/javascript");script.setAttribute("src",url);if(error_callback)TRIALPAY.social.add_event(script,'error',error_callback);element.appendChild(script)}else window.setTimeout(helper,500)};helper()},_message_queue:{},_push_swf_message:function(context,event_name,params){if(!this._message_queue[context])this._message_queue[context]=[];this._message_queue[context].push([event_name,params])},pop_swf_messages:function(context){var messages=[];if(this._message_queue[context]){messages=this._message_queue[context];if(messages.length>0)this._message_queue[context]=[]};return messages},storePut:function(key,value){if(key&&value)localStorage[key]=JSON.stringify(value)},storeGet:function(key){return localStorage[key]&&JSON.parse(localStorage[key])},lsoPut:function(context,key,value){if(context&&key&&value){var params={};params[key]=value;TRIALPAY.io._push_swf_message(context,'trialpayOnLsoPut',params)}},install_post_message_listener:function(window){window._tp_postMessage_callback=window._tp_postMessage_callback||{};if(!window._tp_postMessage_callback[TRIALPAY._INSTANCE_ID]){window._tp_postMessage_callback[TRIALPAY._INSTANCE_ID]=true;TRIALPAY.social.add_event(window,"message",TRIALPAY.io.post_message_callback)}},post_message_callback:function(event){var origin=event.origin,is_ok=false;is_ok=/^https?:\/\/\w+\.trialpay\.com(:|$)/.test(origin);is_ok=is_ok||/^https?:\/\/\w+\.tp-cdn\.com(:|$)/.test(origin);if(is_ok)TRIALPAY.io.crossdomain_callback('?','#'+event.data)},crossdomain_callback:function(search,hash){var params={};search=hash;if(search&&search.length>1){search=search.substr(1);search=search.split('&');for(var i=0;i<search.length;i++){var param=search[i].split('=');if(param.length>1)params[decodeURIComponent(param[0])]=decodeURIComponent(param[1])};try{if("social"==params.lib)switch(params.method){case'close_overlay':case'call_soldout_handle':case'resize_overlay':case'vast_availability_callback':case'dynamic_api_iframe_callback':TRIALPAY[params.lib][params.method](params.p1,params.p2,params.p3)}}catch(e){}}}}};TRIALPAY._INSTANCE_ID=(new Date()).getTime()+"_"+Math.floor(Math.random()*1000000);TRIALPAY.social.add_event(window,'resize',function(){if(TRIALPAY.social.resize_overlay)TRIALPAY.social.resize_overlay(-1,0)});TRIALPAY.io.install_post_message_listener(window)};if(window.trialpayAsync)if(typeof (window.trialpayAsync)=='function'){window.trialpayAsync()}else if(window.trialpayAsync instanceof Array)(function(args){for(var i=0;i<args.length;i++)args[i]()})(window.trialpayAsync);window.trialpayAsync={push:function(f){f()}}